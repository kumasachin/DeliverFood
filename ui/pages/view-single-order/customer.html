<!doctype html>
<html>

<head>
	<title>View Signle Order</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://cdn.muicss.com/mui-0.10.3/css/mui.min.css" rel="stylesheet" type="text/css" />
	<script src="https://cdn.muicss.com/mui-0.10.3/js/mui.min.js"></script>
	<link href='https://fonts.googleapis.com/css?family=Titillium+Web:400,200,300,600,700' rel='stylesheet'
		type='text/css'>
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

	<link rel="stylesheet" href="../../styles/global.css">
	<link rel="stylesheet" href="single-order.css" />
	<script src="../../js/app.js"></script>
</head>

<body>
	<div class="page-layout-container">
		<header>
			<div class="mui-appbar mui--appbar-line-height">
				<div class="mui-container-fluid d-flex align-item-center">

					<div class="app-bar-leading mui-col-md-4">
						<div class="app-name">
							üçî Food Delivery
						</div>
					</div>
					<div class="app-bar-center mui-col-md-4">
						<div class="user-name text-center" id="userWelcome">
							Welcome!
						</div>
					</div>
					<div class="app-bar-trailing mui-col-md-4">
						<a href="../../pages/browse-restaurants/browse-restaurants.html">Browse Restaurants</a>
						<a href="../../pages/view-orders/customer.html">Orders History</a>
						<a href="../../pages/cart/cart.html">Cart</a>
						<a href="#" onclick="Auth.logout()">Sign Out</a>
					</div>
				</div>
			</div>
		</header>
		<main>
			<div class="layout">
				<div class="header">
					<div class="mui-container">
						<br>
						<div class="title track-order" id="orderTitle">Order Details</div>
						<div class="mui-container" id="orderContainer">
							<!-- Order details will be dynamically loaded here -->
						</div>
		</main>

		<footer>
			<div class="text-center">
				Toptal Food Delivery
			</div>
		</footer>
	</div>

	<script>
		let order = null;
		let orderHistory = [];

		// Initialize page
		document.addEventListener('DOMContentLoaded', async () => {
			// Check authentication
			if (!Auth.requireAuth()) return;

			// Get order UUID from URL parameters
			const urlParams = new URLSearchParams(window.location.search);
			const orderUuid = urlParams.get('order');
			
			if (!orderUuid) {
				Utils.showError('No order specified');
				window.location.href = '../view-orders/customer.html';
				return;
			}

			// Update user welcome message
			const user = Auth.getCurrentUser();
			if (user && user.email) {
				document.getElementById('userWelcome').textContent = `Welcome, ${user.email}!`;
			}

			// Load order details and history
			await loadOrder(orderUuid);
			await loadOrderHistory(orderUuid);

			// Setup auto-refresh for order status
			setInterval(() => {
				loadOrder(orderUuid);
				loadOrderHistory(orderUuid);
			}, 30000); // Refresh every 30 seconds
		});

		async function loadOrder(orderUuid) {
			try {
				order = await API.getOrder(orderUuid);
				renderOrderDetails(order);
			} catch (error) {
				console.error('Failed to load order:', error);
				Utils.showError('Failed to load order details. Please try again.');
			}
		}

		async function loadOrderHistory(orderUuid) {
			try {
				const response = await API.getOrderHistory(orderUuid);
				orderHistory = response.items || response;
				renderOrderTimeline(orderHistory);
			} catch (error) {
				console.error('Failed to load order history:', error);
				// Don't show error for history as it's secondary information
			}
		}

		function renderOrderDetails(orderData) {
			if (!orderData) return;

			document.getElementById('orderTitle').textContent = `Order #${orderData.uuid.substring(0, 8)}`;
			
			const user = Auth.getCurrentUser();
			const availableActions = OrderUtils.getAvailableStatusChanges(orderData.status);
			const canChangeStatus = (action) => OrderUtils.canUserChangeStatus(orderData.status, action, user?.role || 'customer');

			const orderContainer = document.getElementById('orderContainer');
			orderContainer.innerHTML = `
				<div class="col-md-12">
					<div class="well">
						<div class="form-horizontal">
							<div class="mui-container">
								<div class="col-md-12">
									<div class="well">
										<div class="order-details">
											<div class="order-info">
												<div><strong>Restaurant:</strong> ${escapeHtml(orderData.restaurant?.title || 'Unknown Restaurant')}</div>
												<div><strong>Created At:</strong> ${Utils.formatDate(orderData.created_at)}</div>
												<div><strong>Current Status:</strong> 
													<span style="color: ${OrderUtils.getStatusColor(orderData.status)};">
														${OrderUtils.getStatusDisplayName(orderData.status)}
													</span>
												</div>
												<div><strong>Status Updated At:</strong> ${Utils.formatDate(orderData.status_changed_at || orderData.updated_at)}</div>
												<div><strong>Order Items:</strong>
													<ul>
														${orderData.order_items?.map(item => 
															`<li>${escapeHtml(item.name)} x${item.quantity} (${Utils.formatCurrency(item.price)} each)</li>`
														).join('') || '<li>No items found</li>'}
													</ul>
												</div>
												${orderData.coupon_code ? `<div><strong>Coupon Code:</strong> ${escapeHtml(orderData.coupon_code)}</div>` : ''}
												${orderData.discount_percentage ? `<div><strong>Discount Percentage:</strong> ${orderData.discount_percentage}%</div>` : ''}
												${orderData.tip_amount ? `<div><strong>Tip Amount:</strong> ${Utils.formatCurrency(orderData.tip_amount)}</div>` : ''}
												<div><strong>Total Price:</strong> ${Utils.formatCurrency(orderData.total_price)}</div>
											</div>
											<div class="order-actions">
												${getOrderActionButtons(orderData, availableActions, canChangeStatus)}
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="title track-order">Timeline:</div>
						<ul class="timeline" id="timeline">
							<!-- Timeline will be populated separately -->
						</ul>
					</div>
				</div>
			`;
		}

		function getOrderActionButtons(orderData, availableActions, canChangeStatus) {
			const buttons = [];
			
			// Mark as received button
			if (availableActions.includes(ORDER_STATUS.RECEIVED) && canChangeStatus(ORDER_STATUS.RECEIVED)) {
				buttons.push(`
					<button class="mui-btn mui-btn--primary" onclick="updateOrderStatus('${orderData.uuid}', '${ORDER_STATUS.RECEIVED}')">
						Mark Received
					</button>
				`);
			}
			
			// Cancel order button
			if (availableActions.includes(ORDER_STATUS.CANCELLED) && canChangeStatus(ORDER_STATUS.CANCELLED)) {
				buttons.push(`
					<button class="mui-btn mui-btn--danger" onclick="updateOrderStatus('${orderData.uuid}', '${ORDER_STATUS.CANCELLED}')">
						Cancel Order
					</button>
				`);
			}

			return buttons.join(' ');
		}

		function renderOrderTimeline(historyData) {
			const timeline = document.getElementById('timeline');
			if (!timeline || !historyData || historyData.length === 0) return;

			timeline.innerHTML = historyData.map(entry => `
				<li class="li complete">
					<div class="timestamp">
						<span class="date">${Utils.formatDate(entry.changed_at)}</span>
					</div>
					<div class="status">
						<h4>${OrderUtils.getStatusDisplayName(entry.status)}</h4>
					</div>
				</li>
			`).join('');
		}

		async function updateOrderStatus(orderUuid, newStatus) {
			try {
				await API.updateOrderStatus(orderUuid, newStatus);
				Utils.showSuccess(`Order status updated to ${OrderUtils.getStatusDisplayName(newStatus)}`);
				await loadOrder(orderUuid);
				await loadOrderHistory(orderUuid);
			} catch (error) {
				console.error('Failed to update order status:', error);
				Utils.showError('Failed to update order status. Please try again.');
			}
		}

		function escapeHtml(text) {
			if (!text) return '';
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}
	</script>
</body>

</html>
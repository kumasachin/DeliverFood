<!doctype html>
<html>

<head>
    <title>Browse Restaurant Meals</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.muicss.com/mui-0.10.3/css/mui.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.muicss.com/mui-0.10.3/js/mui.min.js"></script>

    <link rel="stylesheet" href="../../styles/global.css">
    <link rel="stylesheet" href="browse-meals.css" />
    <script src="../../js/app.js"></script>
</head>

<body>
    <div class="page-layout-container">
        <header>
            <div class="mui-appbar mui--appbar-line-height">
                <div class="mui-container-fluid d-flex align-item-center">

                    <div class="app-bar-leading mui-col-md-4">
                        <div class="app-name">
                            üçî Food Delivery
                        </div>
                    </div>
                    <div class="app-bar-center mui-col-md-4">
                        <div class="user-name text-center" id="userWelcome">
                            Welcome!
                        </div>
                    </div>
                    <div class="app-bar-trailing mui-col-md-4">
                        <a href="../../pages/browse-restaurants/browse-restaurants.html">Browse Restaurants</a>
                        <a href="../../pages/view-orders/customer.html">View Orders</a>
                        <a href="../../pages/cart/cart.html">Cart (<span id="cartCount">0</span>)</a>
                        <a href="#" onclick="Auth.logout()">Sign Out</a>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div class="layout">
                <div class="header">
                    <div class="mui-container">
                        <br>
                        <div class="title" id="pageTitle">Browse Restaurant Meals</div>
                    </div>


                </div>
                <div class="content">
                    <div class="mui-container" id="mealsContainer">
                        <!-- Meals will be dynamically loaded here -->
                    </div>
                </div>
                                    <div class="card-trailing">
                                        <a class="mui-btn mui-btn--flat mui-btn--small buy-button" href="#">Add to
                                            Cart</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mui-row">
                            <div class="mui-panel">
                                <div class="card">
                                    <div class="card-avatar">
                                        <img class="card-image" src="../../assets/burger.png" />
                                    </div>
                                    <div class="card-details">
                                        <a href="../view-meal/view-meal.html" class="name">Meal Name</a>
                                        <div>
                                            Description
                                        </div>
                                        <div class="section">
                                            Section
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="price">$1,234,567</div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="item-quantity">
                                            <button class="quantity-btn">-</button>
                                            <span id="quantity">1</span>
                                            <button class="quantity-btn">+</button>
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <a class="mui-btn mui-btn--flat mui-btn--small buy-button" href="#">Add to
                                            Cart</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mui-row">
                            <div class="mui-panel">
                                <div class="card">
                                    <div class="card-avatar">
                                        <img class="card-image" src="../../assets/burger.png" />
                                    </div>
                                    <div class="card-details">
                                        <a href="../view-meal/view-meal.html" class="name">Meal Name</a>
                                        <div>
                                            Description
                                        </div>
                                        <div class="section">
                                            Section
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="price">$1,234,567</div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="item-quantity">
                                            <button class="quantity-btn">-</button>
                                            <span id="quantity">1</span>
                                            <button class="quantity-btn">+</button>
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <a class="mui-btn mui-btn--flat mui-btn--small buy-button" href="#">Add to
                                            Cart</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mui-row">
                            <div class="mui-panel">
                                <div class="card">
                                    <div class="card-avatar">
                                        <img class="card-image" src="../../assets/burger.png" />
                                    </div>
                                    <div class="card-details">
                                        <a href="../view-meal/view-meal.html" class="name">Meal Name</a>
                                        <div>
                                            Description
                                        </div>
                                        <div class="section">
                                            Section
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="price">$1,234,567</div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="item-quantity">
                                            <button class="quantity-btn">-</button>
                                            <span id="quantity">1</span>
                                            <button class="quantity-btn">+</button>
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <a class="mui-btn mui-btn--flat mui-btn--small buy-button" href="#">Add to
                                            Cart</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mui-row">
                            <div class="mui-panel">
                                <div class="card">
                                    <div class="card-avatar">
                                        <img class="card-image" src="../../assets/burger.png" />
                                    </div>
                                    <div class="card-details">
                                        <a href="../view-meal/view-meal.html" class="name">Meal Name</a>
                                        <div>
                                            Description
                                        </div>
                                        <div class="section">
                                            Section
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="price">$1,234,567</div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="item-quantity">
                                            <button class="quantity-btn">-</button>
                                            <span id="quantity">1</span>
                                            <button class="quantity-btn">+</button>
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <a class="mui-btn mui-btn--flat mui-btn--small buy-button" href="#">Add to
                                            Cart</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mui-row">
                            <div class="mui-panel">
                                <div class="card">
                                    <div class="card-avatar">
                                        <img class="card-image" src="../../assets/burger.png" />
                                    </div>
                                    <div class="card-details">
                                        <a href="../view-meal/view-meal.html" class="name">Meal Name</a>
                                        <div>
                                            Description
                                        </div>
                                        <div class="section">
                                            Section
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="price">$1,234,567</div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="item-quantity">
                                            <button class="quantity-btn">-</button>
                                            <span id="quantity">1</span>
                                            <button class="quantity-btn">+</button>
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <a class="mui-btn mui-btn--flat mui-btn--small buy-button" href="#">Add to
                                            Cart</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mui-row">
                            <div class="mui-panel">
                                <div class="card">
                                    <div class="card-avatar">
                                        <img class="card-image" src="../../assets/burger.png" />
                                    </div>
                                    <div class="card-details">
                                        <a href="../view-meal/view-meal.html" class="name">Meal Name</a>
                                        <div>
                                            Description
                                        </div>
                                        <div class="section">
                                            Section
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="price">$1,234,567</div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="item-quantity">
                                            <button class="quantity-btn">-</button>
                                            <span id="quantity">1</span>
                                            <button class="quantity-btn">+</button>
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <a class="mui-btn mui-btn--flat mui-btn--small buy-button" href="#">Add to
                                            Cart</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mui-row">
                            <div class="mui-panel">
                                <div class="card">
                                    <div class="card-avatar">
                                        <img class="card-image" src="../../assets/burger.png" />
                                    </div>
                                    <div class="card-details">
                                        <a href="../view-meal/view-meal.html" class="name">Meal Name</a>
                                        <div>
                                            Description
                                        </div>
                                        <div class="section">
                                            Section
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="price">$1,234,567</div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="item-quantity">
                                            <button class="quantity-btn">-</button>
                                            <span id="quantity">1</span>
                                            <button class="quantity-btn">+</button>
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <a class="mui-btn mui-btn--flat mui-btn--small buy-button" href="#">Add to
                                            Cart</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mui-row">
                            <div class="mui-panel">
                                <div class="card">
                                    <div class="card-avatar">
                                        <img class="card-image" src="../../assets/burger.png" />
                                    </div>
                                    <div class="card-details">
                                        <a href="../view-meal/view-meal.html" class="name">Meal Name</a>
                                        <div>
                                            Description
                                        </div>
                                        <div class="section">
                                            Section
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="price">$1,234,567</div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="item-quantity">
                                            <button class="quantity-btn">-</button>
                                            <span id="quantity">1</span>
                                            <button class="quantity-btn">+</button>
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <a class="mui-btn mui-btn--flat mui-btn--small buy-button" href="#">Add to
                                            Cart</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mui-row">
                            <div class="mui-panel">
                                <div class="card">
                                    <div class="card-avatar">
                                        <img class="card-image" src="../../assets/burger.png" />
                                    </div>
                                    <div class="card-details">
                                        <a href="../view-meal/view-meal.html" class="name">Meal Name</a>
                                        <div>
                                            Description
                                        </div>
                                        <div class="section">
                                            Section
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="price">$1,234,567</div>
                                    </div>
                                    <div class="card-trailing">
                                        <div class="item-quantity">
                                            <button class="quantity-btn">-</button>
                                            <span id="quantity">1</span>
                                            <button class="quantity-btn">+</button>
                                        </div>
                                    </div>
                                    <div class="card-trailing">
                                        <a class="mui-btn mui-btn--flat mui-btn--small buy-button" href="#">Add to
                                            Cart</a>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
                <div class="footer">
                    <!-- pagination -->

                    <div class="pagination">
                        <button class="mui-btn mui-btn--flat mui-btn--small">Previous</button>
                        <button class="mui-btn mui-btn--primary mui-btn--small">1</button>
                        <button class="mui-btn mui-btn--flat mui-btn--small">2</button>
                        <button class="mui-btn mui-btn--flat mui-btn--small">3</button>
                        <button class="mui-btn mui-btn--flat mui-btn--small" disabled>...</button>
                        <button class="mui-btn mui-btn--flat mui-btn--small">8</button>
                        <button class="mui-btn mui-btn--flat mui-btn--small">9</button>
                        <button class="mui-btn mui-btn--flat mui-btn--small">10</button>
                        <button class="mui-btn mui-btn--flat mui-btn--small">Next</button>
                    </div>
                </div>

        </main>

        <footer>
            <div class="text-center">
                Toptal Food Delivery
            </div>
        </footer>
    </div>

    <script>
        let meals = [];
        let restaurantUuid = null;
        let restaurant = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            if (!Auth.requireAuth()) return;

            // Get restaurant UUID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            restaurantUuid = urlParams.get('restaurant');
            
            if (!restaurantUuid) {
                Utils.showError('No restaurant specified');
                window.location.href = '../browse-restaurants/browse-restaurants.html';
                return;
            }

            // Update user welcome message
            const user = Auth.getCurrentUser();
            if (user && user.email) {
                document.getElementById('userWelcome').textContent = `Welcome, ${user.email}!`;
            }

            // Update cart count
            updateCartCount();

            // Load restaurant and meals
            await loadRestaurant();
            await loadMeals();
        });

        async function loadRestaurant() {
            try {
                restaurant = await API.getRestaurant(restaurantUuid);
                document.getElementById('pageTitle').textContent = `${restaurant.title} - Meals`;
            } catch (error) {
                console.error('Failed to load restaurant:', error);
                Utils.showError('Failed to load restaurant information.');
            }
        }

        async function loadMeals() {
            try {
                const response = await API.getRestaurantMeals(restaurantUuid);
                meals = response.items || response;
                renderMeals(meals);
            } catch (error) {
                console.error('Failed to load meals:', error);
                Utils.showError('Failed to load meals. Please try again.');
            }
        }

        function renderMeals(mealList) {
            const container = document.getElementById('mealsContainer');
            
            if (mealList.length === 0) {
                container.innerHTML = `
                    <div class="mui-row">
                        <div class="mui-col-md-12 text-center">
                            <h3>No meals available</h3>
                            <p>This restaurant hasn't added any meals yet.</p>
                            <a href="../browse-restaurants/browse-restaurants.html" class="mui-btn mui-btn--primary">
                                Browse Other Restaurants
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = mealList.map((meal, index) => `
                <div class="mui-row">
                    <div class="mui-panel">
                        <div class="card">
                            <div class="card-avatar">
                                <img class="card-image" src="../../assets/meals/meal.png" 
                                     onerror="this.src='../../assets/burger.png'" />
                            </div>
                            <div class="card-details">
                                <a href="../view-meal/view-meal.html?meal=${meal.uuid}" class="name">
                                    ${escapeHtml(meal.name)}
                                </a>
                                <div>${escapeHtml(meal.description)}</div>
                                <div class="section">${Utils.formatCurrency(meal.price)}</div>
                            </div>
                            <div class="card-trailing">
                                <div class="item-quantity">
                                    <button class="quantity-btn" onclick="changeQuantity('${meal.uuid}', -1)">-</button>
                                    <span id="quantity-${meal.uuid}">1</span>
                                    <button class="quantity-btn" onclick="changeQuantity('${meal.uuid}', 1)">+</button>
                                </div>
                            </div>
                            <div class="card-trailing">
                                <button class="mui-btn mui-btn--primary mui-btn--small" 
                                        onclick="addToCart('${meal.uuid}')">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function changeQuantity(mealUuid, change) {
            const quantityElement = document.getElementById(`quantity-${mealUuid}`);
            let currentQuantity = parseInt(quantityElement.textContent);
            currentQuantity = Math.max(1, currentQuantity + change);
            quantityElement.textContent = currentQuantity;
        }

        function addToCart(mealUuid) {
            const meal = meals.find(m => m.uuid === mealUuid);
            const quantity = parseInt(document.getElementById(`quantity-${mealUuid}`).textContent);
            
            if (Cart.addItem(meal, restaurantUuid, quantity)) {
                updateCartCount();
                Utils.showSuccess(`Added ${quantity} ${meal.name}(s) to cart`);
            }
        }

        function updateCartCount() {
            const count = Cart.getItemCount();
            document.getElementById('cartCount').textContent = count;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>
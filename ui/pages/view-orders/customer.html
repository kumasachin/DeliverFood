<!doctype html>
<html>

<head>
	<title>View Orders</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://cdn.muicss.com/mui-0.10.3/css/mui.min.css" rel="stylesheet" type="text/css" />
	<script src="https://cdn.muicss.com/mui-0.10.3/js/mui.min.js"></script>
	<link href='https://fonts.googleapis.com/css?family=Titillium+Web:400,200,300,600,700' rel='stylesheet'
		type='text/css'>
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

	<link rel="stylesheet" href="../../styles/global.css">
	<link rel="stylesheet" href="orders.css" />
	<script src="../../js/app.js"></script>
</head>

<body>
	<div class="page-layout-container">
		<header>
			<div class="mui-appbar mui--appbar-line-height">
				<div class="mui-container-fluid d-flex align-item-center">

					<div class="app-bar-leading mui-col-md-4">
						<div class="app-name">
							üçî Food Delivery
						</div>
					</div>
					<div class="app-bar-center mui-col-md-4">
						<div class="user-name text-center" id="userWelcome">
							Welcome!
						</div>
					</div>
					<div class="app-bar-trailing mui-col-md-4">
						<a href="../../pages/browse-restaurants/browse-restaurants.html">Browse Restaurants</a>
						<a href="../../pages/cart/cart.html">Cart</a>
						<a href="#" onclick="Auth.logout()">Sign Out</a>
					</div>
				</div>
			</div>
		</header>
		<main>
			<div class="layout">
				<div class="header">
					<div class="mui-container">
						<br>

						<div class="title">Orders History</div>
						<div class="mui-container">
							<div class="description">Here are your previous orders</div>
							<div class="table-container">
								<table class="mui-table mui-table--bordered">
									<thead>
										<tr>
											<th>Order ID</th>
											<th>Order Date</th>
											<th>Restaurant</th>
											<th>Items</th>
											<th>Total</th>
											<th>Status</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody id="ordersTableBody">
										<!-- Orders will be dynamically loaded here -->
									</tbody>
								</table>
							</div>
						</div>
		</main>

		<footer>
			<div class="text-center">
				Toptal Food Delivery
			</div>
		</footer>

	</div>

	<script>
		let orders = [];

		// Initialize page
		document.addEventListener('DOMContentLoaded', async () => {
			// Check authentication
			if (!Auth.requireAuth()) return;

			// Update user welcome message
			const user = Auth.getCurrentUser();
			if (user && user.email) {
				document.getElementById('userWelcome').textContent = `Welcome, ${user.email}!`;
			}

			// Load orders
			await loadOrders();

			// Setup auto-refresh for order status
			setInterval(loadOrders, 30000); // Refresh every 30 seconds
		});

		async function loadOrders() {
			try {
				const response = await API.getOrders();
				orders = response.items || response;
				renderOrders(orders);
			} catch (error) {
				console.error('Failed to load orders:', error);
				Utils.showError('Failed to load orders. Please try again.');
			}
		}

		function renderOrders(orderList) {
			const tbody = document.getElementById('ordersTableBody');
			
			if (orderList.length === 0) {
				tbody.innerHTML = `
					<tr>
						<td colspan="7" class="text-center">
							<p>No orders found</p>
							<a href="../../pages/browse-restaurants/browse-restaurants.html" class="mui-btn mui-btn--primary">
								Start Ordering
							</a>
						</td>
					</tr>
				`;
				return;
			}

			tbody.innerHTML = orderList.map(order => {
				const availableActions = OrderUtils.getAvailableStatusChanges(order.status);
				const user = Auth.getCurrentUser();
				const canChangeStatus = (action) => OrderUtils.canUserChangeStatus(order.status, action, user?.role || 'customer');
				
				// Get order items summary
				const itemsSummary = order.order_items?.map(item => `${item.name} (${item.quantity})`).join(', ') || 'N/A';
				
				return `
					<tr>
						<td>
							<a href="../view-single-order/customer.html?order=${order.uuid}">
								#${order.uuid.substring(0, 8)}
							</a>
						</td>
						<td>${Utils.formatDate(order.created_at)}</td>
						<td>${escapeHtml(order.restaurant?.title || 'Unknown Restaurant')}</td>
						<td>${escapeHtml(itemsSummary)}</td>
						<td>${Utils.formatCurrency(order.total_price)}</td>
						<td>
							<span style="color: ${OrderUtils.getStatusColor(order.status)};">
								${OrderUtils.getStatusDisplayName(order.status)}
							</span>
						</td>
						<td>
							${getOrderActionButtons(order, availableActions, canChangeStatus)}
						</td>
					</tr>
				`;
			}).join('');
		}

		function getOrderActionButtons(order, availableActions, canChangeStatus) {
			const buttons = [];
			
			// Mark as received button
			if (availableActions.includes(ORDER_STATUS.RECEIVED) && canChangeStatus(ORDER_STATUS.RECEIVED)) {
				buttons.push(`
					<button class="mui-btn mui-btn--small mui-btn--primary" 
							onclick="updateOrderStatus('${order.uuid}', '${ORDER_STATUS.RECEIVED}')">
						Mark Received
					</button>
				`);
			}
			
			// Cancel order button
			if (availableActions.includes(ORDER_STATUS.CANCELLED) && canChangeStatus(ORDER_STATUS.CANCELLED)) {
				buttons.push(`
					<button class="mui-btn mui-btn--small mui-btn--danger" 
							onclick="updateOrderStatus('${order.uuid}', '${ORDER_STATUS.CANCELLED}')">
						Cancel Order
					</button>
				`);
			}

			// View details button
			buttons.push(`
				<a href="../view-single-order/customer.html?order=${order.uuid}" 
				   class="mui-btn mui-btn--small mui-btn--flat">
					View Details
				</a>
			`);

			return buttons.join(' ');
		}

		async function updateOrderStatus(orderUuid, newStatus) {
			try {
				await API.updateOrderStatus(orderUuid, newStatus);
				Utils.showSuccess(`Order status updated to ${OrderUtils.getStatusDisplayName(newStatus)}`);
				await loadOrders(); // Refresh the list
			} catch (error) {
				console.error('Failed to update order status:', error);
				Utils.showError('Failed to update order status. Please try again.');
			}
		}

		function escapeHtml(text) {
			if (!text) return '';
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}
	</script>
</body>

</html>